<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>TOURNAMENT DIRECTOR V9.4</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 10px; background: #eceff1; font-size: 11px; color: #333; }
        
        /* TOOLBAR */
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 6px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 11px; }
        .btn-add { background: #0277bd; } 
        .btn-refresh { background: #546e7a; }

        /* TABEL UTAMA */
        .table-wrap { background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; min-height: 500px; padding-bottom: 50px; }
        table { border-collapse: collapse; width: 100%; }
        
        /* HEADER */
        th { background: #263238; color: white; padding: 10px 2px; text-align: center; border-right: 1px solid #37474f; font-size: 10px; text-transform: uppercase; white-space: nowrap; vertical-align: middle; }
        
        /* SEL TABEL */
        td { padding: 1px; border-bottom: 1px solid #eee; text-align: center; height: 42px; vertical-align: middle; }
        tr:hover { background: #f1f8e9; }
        
        /* INPUT FIELDS STANDAR */
        input { border: none; background: transparent; text-align: center; font-size: 11px; width: 100%; padding: 4px; height: 100%; box-sizing: border-box; }
        input:focus { background: white; outline: 1px solid #29b6f6; }

        /* --- FIX ANGKA TERPOTONG (PENTING!) --- */
        /* 1. Hilangkan Tombol Panah (Spinner) di Input Number */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* 2. Input Skor Spesifik */
        input.inp-score {
            font-weight: 800; 
            font-size: 14px; /* Huruf lebih besar dikit biar jelas */
            padding: 0;      /* Hapus padding biar muat */
            width: 100%;
        }

        /* TEXTAREA WRAPPING */
        textarea.inp-wrap {
            border: none; background: transparent; 
            font-family: 'Segoe UI', sans-serif; font-size: 11px;
            width: 100%; height: 100%; min-height: 38px;
            padding: 4px; resize: none; overflow: hidden;
            line-height: 1.2; box-sizing: border-box;
            vertical-align: middle; text-align: center;
            display: flex; align-items: center; justify-content: center;
        }
        textarea.inp-wrap:focus { background: white; outline: 1px solid #29b6f6; text-align: left; }

        /* LEBAR KOLOM */
        .td-team-a { width: 160px; min-width: 140px; }
        .td-team-a textarea { text-align: right; font-weight: bold; font-size: 12px; }
        
        .td-team-b { width: 160px; min-width: 140px; }
        .td-team-b textarea { text-align: left; font-weight: bold; font-size: 12px; }

        .col-meta { min-width: 70px; }
        .col-jam  { width: 50px; }

        /* WARNA KOLOM SKOR (DIPERLEBAR DIKIT) */
        .bg-set { background: #e3f2fd; border-right: 1px solid #fff; width: 36px; } /* Lebar jadi 36px */
        .bg-poin { background: #fff3e0; color: #ef6c00; width: 40px; border-left: 1px solid #ddd; }
        .bg-grey { background: #fafafa; }

        .inp-pin { background: #ffebee; color: #c62828; font-weight: bold; width: 40px; border-radius: 3px; }

        /* STATUS BADGE */
        .badge { padding: 4px 8px; border-radius: 3px; color: white; font-size: 9px; cursor: pointer; white-space: nowrap; }
        .st-live { background: #e91e63; animation: pulse 1.5s infinite; }
        .st-pending { background: #90a4ae; }
        .st-done { background: #43a047; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* MODAL */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:99; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 700px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .grid-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .col-2 { grid-column: span 2; } .col-4 { grid-column: span 4; }
        .form-inp { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .label { font-size: 10px; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }

        #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 999; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>
    <div id="toast">üíæ Tersimpan</div>

    <div class="toolbar">
        <h3 style="margin:0 20px 0 0; color:#37474f;">MASTER CONTROL V9.4</h3>
        <button class="btn btn-add" onclick="openModal()">+ MATCH BARU</button>
        <button class="btn btn-refresh" onclick="loadData()">REFRESH DATA</button>
        <div style="flex:1; text-align:right; color:#78909c;">
            *Kolom Skor muat angka 21+
        </div>
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th rowspan="2" width="30">NO</th>
                    <th rowspan="2" width="40">PIN</th>
                    <th rowspan="2" width="60">TGL</th>
                    <th rowspan="2" width="40">JAM</th>
                    <th rowspan="2" width="70">COURT</th>
                    <th rowspan="2" width="90">KATEGORI</th>
                    <th rowspan="2" width="70">BABAK</th>
                    <th rowspan="2" width="60">WASIT</th>
                    
                    <th rowspan="2" style="text-align:right">TIM A</th>
                    <th colspan="2">S1</th> <th colspan="2">S2</th> <th colspan="2">S3</th> <th colspan="2">S4</th> <th colspan="2">S5</th>
                    <th colspan="2" style="background:#e65100">POIN</th>
                    
                    <th rowspan="2" style="text-align:left">TIM B</th>
                    <th rowspan="2" width="30">WO</th>
                    <th rowspan="2" width="60">STATUS</th>
                    <th rowspan="2" width="30">DEL</th>
                </tr>
                <tr>
                    <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th>
                    <th style="background:#ff9800">A</th> <th style="background:#ff9800">B</th>
                </tr>
            </thead>
            <tbody id="tabel-body"></tbody>
        </table>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0">Input Jadwal Pertandingan</h3>
            <input type="hidden" id="edit-id">
            <div class="grid-form">
                <div><span class="label">NO MATCH</span><input class="form-inp" id="i-no" placeholder="1"></div>
                <div><span class="label">PIN WASIT</span><input class="form-inp" id="i-pin" value="1234"></div>
                <div><span class="label">TANGGAL</span><input class="form-inp" id="i-date" placeholder="31 Jan"></div>
                <div><span class="label">JAM</span><input class="form-inp" id="i-jam" placeholder="09.00"></div>
                
                <div class="col-2"><span class="label">KATEGORI</span><input class="form-inp" id="i-cat" placeholder="Men's Double A"></div>
                <div class="col-2"><span class="label">BABAK / ROUND</span><input class="form-inp" id="i-round" placeholder="Grup A / Final"></div>
                
                <div class="col-2"><span class="label">NAMA COURT</span><input class="form-inp" id="i-court" placeholder="Court 1"></div>
                <div class="col-2"><span class="label">NAMA WASIT</span><input class="form-inp" id="i-ref" placeholder="Nama Wasit"></div>
                
                <div class="col-2"><span class="label">TIM A (HOME)</span><input class="form-inp" id="i-ta" style="font-weight:bold"></div>
                <div class="col-2"><span class="label">TIM B (AWAY)</span><input class="form-inp" id="i-tb" style="font-weight:bold"></div>
                
                <div class="col-4"><span class="label">CATATAN (OPTIONAL)</span><input class="form-inp" id="i-note" placeholder="Contoh: Ditunda hujan"></div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeModal()" style="padding:10px; background:#eee; border:none; margin-right:5px; cursor:pointer;">Batal</button>
                <button onclick="saveMatch()" class="btn btn-add">SIMPAN DATA</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gubcvxiupehbdpigrdct.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k1y6fNI2opEXhwqKMbGYcA__2nD0yT6';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadData() {
            const { data } = await db.from('matches').select('*').order('created_at', {ascending: true});
            if(data) render(data);
        }

        db.channel('public:matches').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, () => loadData()).subscribe();

        function render(data) {
            const tbody = document.getElementById('tabel-body');
            tbody.innerHTML = "";
            data.forEach(m => {
                // Helpers
                const inp = (f, v, c='') => `<input value="${v||''}" onchange="upd('${m.id}','${f}',this.value)" class="${c}">`;
                // INPUT SCORE (TYPE NUMBER)
                const num = (f, v) => `<input type="number" value="${v}" onchange="upd('${m.id}','${f}',this.value)" class="inp-score">`;
                const txt = (f, v, c='') => `<textarea onchange="upd('${m.id}','${f}',this.value)" class="inp-wrap ${c}">${v||''}</textarea>`;

                let badgeClass = m.status === 'LIVE' ? 'st-live' : (m.status === 'FINISHED' ? 'st-done' : 'st-pending');
                let badgeIcon = m.status === 'LIVE' ? 'üõë STOP' : 'üì° LIVE';
                let woCheck = m.is_wo ? 'checked' : '';
                
                let row = `<tr>
                    <td>${inp('match_no', m.match_no)}</td>
                    <td>${inp('pin', m.pin, 'inp-pin')}</td>
                    <td class="bg-grey col-meta">${txt('date', m.date)}</td>
                    <td class="bg-grey col-jam">${inp('time', m.time)}</td>
                    <td class="bg-grey col-meta">${txt('court_name', m.court_name, 'inp-court')}</td>
                    <td class="bg-grey col-meta">${txt('category', m.category)}</td>
                    <td class="bg-grey col-meta">${txt('round', m.round)}</td>
                    <td class="bg-grey col-meta">${txt('referee_name', m.referee_name)}</td>
                    
                    <td class="td-team-a">${txt('team_a', m.team_a)}</td>
                    
                    <td class="bg-set">${num('set1_a', m.set1_a)}</td> <td class="bg-set">${num('set1_b', m.set1_b)}</td>
                    <td class="bg-set">${num('set2_a', m.set2_a)}</td> <td class="bg-set">${num('set2_b', m.set2_b)}</td>
                    <td class="bg-set">${num('set3_a', m.set3_a)}</td> <td class="bg-set">${num('set3_b', m.set3_b)}</td>
                    <td class="bg-set">${num('set4_a', m.set4_a)}</td> <td class="bg-set">${num('set4_b', m.set4_b)}</td>
                    <td class="bg-set">${num('set5_a', m.set5_a)}</td> <td class="bg-set">${num('set5_b', m.set5_b)}</td>
                    
                    <td class="bg-poin">${inp('points_a', m.points_a, 'inp-score')}</td>
                    <td class="bg-poin">${inp('points_b', m.points_b, 'inp-score')}</td>
                    
                    <td class="td-team-b">${txt('team_b', m.team_b)}</td>
                    
                    <td><input type="checkbox" ${woCheck} onchange="upd('${m.id}','is_wo',this.checked)"></td>
                    
                    <td><span class="badge ${badgeClass}" onclick="toggleStatus('${m.id}', '${m.status}', '${m.court_name}')">${badgeIcon}</span></td>
                    <td><button onclick="del('${m.id}')" style="border:none; bg:none; cursor:pointer;">üóëÔ∏è</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function upd(id, field, val) {
            showToast();
            await db.from('matches').update({[field]: val}).eq('id', id);
        }

        async function toggleStatus(id, status, court) {
            let next = status === 'LIVE' ? 'PENDING' : 'LIVE';
            if(next === 'LIVE') {
                const {data} = await db.from('matches').select('*').ilike('court_name', court).eq('status', 'LIVE');
                if(data.length > 0) return alert('Court ini sedang dipakai LIVE!');
            }
            await db.from('matches').update({status: next}).eq('id', id);
        }

        function openModal() { 
            document.getElementById('modal').style.display = 'flex'; 
            document.querySelectorAll('.form-inp').forEach(i=>i.value="");
            document.getElementById('i-pin').value = Math.floor(1000 + Math.random() * 9000);
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        
        async function saveMatch() {
            const payload = {
                match_no: document.getElementById('i-no').value,
                pin: document.getElementById('i-pin').value,
                time: document.getElementById('i-jam').value,
                date: document.getElementById('i-date').value,
                category: document.getElementById('i-cat').value,
                round: document.getElementById('i-round').value,
                court_name: document.getElementById('i-court').value,
                referee_name: document.getElementById('i-ref').value,
                team_a: document.getElementById('i-ta').value,
                team_b: document.getElementById('i-tb').value,
                notes: document.getElementById('i-note').value
            };
            await db.from('matches').insert([payload]);
            closeModal();
        }

        async function del(id) { if(confirm('Hapus?')) await db.from('matches').delete().eq('id', id); }
        function showToast() { 
            const t = document.getElementById('toast'); t.style.display='block'; 
            setTimeout(()=>t.style.display='none', 800); 
        }

        loadData();
    </script>
</body>
</html>