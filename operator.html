<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>MASTER CONTROL V9.8 (SECURE)</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 10px; background: #eceff1; font-size: 11px; color: #333; overflow: hidden; }
        
        /* 1. LAYAR LOGIN (TUMPUKAN PALING ATAS) */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #212121; z-index: 999999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-card { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .inp-pass { padding: 15px; width: 100%; font-size: 18px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; text-align: center; font-weight: bold; }
        .btn-enter { background: #D81B60; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 900; font-size: 16px; letter-spacing: 1px; transition: 0.2s; }
        .btn-enter:hover { background: #ad1457; transform: scale(1.02); }

        /* 2. KONTEN UTAMA (DISEMBUNYIKAN) */
        #main-app { display: none; }

        /* TABEL & UI */
        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 6px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: bold; font-size: 11px; }
        .btn-add { background: #0277bd; } 
        .btn-refresh { background: #546e7a; }

        .table-wrap { background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; height: 85vh; padding-bottom: 50px; }
        table { border-collapse: collapse; width: 100%; }
        
        th { background: #263238; color: white; padding: 10px 2px; text-align: center; border-right: 1px solid #37474f; font-size: 10px; text-transform: uppercase; white-space: nowrap; vertical-align: middle; }
        td { padding: 1px; border-bottom: 1px solid #eee; text-align: center; height: 42px; vertical-align: middle; }
        tr:hover { background: #f1f8e9; }
        
        input { border: none; background: transparent; text-align: center; font-size: 11px; width: 100%; padding: 4px; box-sizing: border-box; }
        input:focus { background: white; outline: 1px solid #29b6f6; }
        
        textarea.inp-wrap { border: none; background: transparent; font-family: 'Segoe UI', sans-serif; font-size: 11px; width: 100%; height: 100%; min-height: 38px; padding: 4px; resize: none; overflow: hidden; line-height: 1.2; box-sizing: border-box; vertical-align: middle; text-align: center; display: flex; align-items: center; justify-content: center; }
        textarea.inp-wrap:focus { background: white; outline: 1px solid #29b6f6; text-align: left; }

        .td-team-a textarea { text-align: right; font-weight: bold; }
        .td-team-b textarea { text-align: left; font-weight: bold; }
        .td-team-a, .td-team-b { width: 160px; min-width: 140px; }

        .bg-set { background: #e3f2fd; border-right: 1px solid #fff; width: 36px; }
        .bg-poin { background: #fff3e0; color: #ef6c00; width: 40px; border-left: 1px solid #ddd; }
        .inp-score { font-weight: 800; font-size: 14px; padding: 0; width: 100%; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .badge { padding: 4px 8px; border-radius: 3px; color: white; font-size: 9px; cursor: pointer; white-space: nowrap; display:inline-block; margin-right:5px;}
        .st-live { background: #e91e63; animation: pulse 1.5s infinite; }
        .st-pending { background: #90a4ae; }
        .st-done { background: #43a047; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .btn-fin { background: #43a047; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px; }
        .inp-pin { background: #ffebee; color: #c62828; font-weight: bold; width: 40px; border-radius: 3px; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:99; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 700px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .grid-form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .col-2 { grid-column: span 2; } .col-4 { grid-column: span 4; }
        .form-inp { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .label { font-size: 10px; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }

        #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 999; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="margin-top:0; color:#37474f;">üîí SECURITY CHECK</h2>
            <p style="font-size:13px; color:#888; margin-bottom:20px;">Area Terbatas. Masukkan Kode Akses.</p>
            <input type="password" id="pass-input" class="inp-pass" placeholder="Ketik Kode..." onkeyup="if(event.keyCode===13) checkPass()">
            <button onclick="checkPass()" class="btn-enter">BUKA AKSES</button>
            <p id="err-msg" style="color:red; font-size:12px; margin-top:10px; display:none;">Kode Salah!</p>
        </div>
    </div>

    <div id="main-app">
        <div id="toast">üíæ Tersimpan</div>

        <div class="toolbar">
            <h3 style="margin:0 20px 0 0; color:#37474f;">MASTER CONTROL V9.8</h3>
            <button class="btn btn-add" onclick="openModal()">+ MATCH BARU</button>
            <button class="btn btn-refresh" onclick="loadData()">REFRESH DATA</button>
            <div style="flex:1; text-align:right; color:#78909c;">
                <span style="background:#e8f5e9; color:#2e7d32; padding:3px 8px; border-radius:4px; font-weight:bold;">SECURE MODE ON</span>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2" width="30">NO</th>
                        <th rowspan="2" width="40">PIN</th>
                        <th rowspan="2" width="60">TGL</th>
                        <th rowspan="2" width="40">JAM</th>
                        <th rowspan="2" width="70">COURT</th>
                        <th rowspan="2" width="90">KATEGORI</th>
                        <th rowspan="2" width="70">BABAK</th>
                        <th rowspan="2" width="60">WASIT</th>
                        
                        <th rowspan="2" style="text-align:right">TIM A</th>
                        <th colspan="2">S1</th> <th colspan="2">S2</th> <th colspan="2">S3</th> <th colspan="2">S4</th> <th colspan="2">S5</th>
                        <th colspan="2" style="background:#e65100">POIN</th>
                        
                        <th rowspan="2" style="text-align:left">TIM B</th>
                        <th rowspan="2" width="30">WO</th>
                        <th rowspan="2" width="90">STATUS</th>
                        <th rowspan="2" width="30">DEL</th>
                    </tr>
                    <tr>
                        <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th> <th>A</th> <th>B</th>
                        <th style="background:#ff9800">A</th> <th style="background:#ff9800">B</th>
                    </tr>
                </thead>
                <tbody id="tabel-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0">Input Jadwal</h3>
            <div class="grid-form">
                <div><span class="label">NO MATCH</span><input class="form-inp" id="i-no"></div>
                <div><span class="label">PIN</span><input class="form-inp" id="i-pin" value="1234"></div>
                <div><span class="label">TGL</span><input class="form-inp" id="i-date"></div>
                <div><span class="label">JAM</span><input class="form-inp" id="i-jam"></div>
                <div class="col-2"><span class="label">KATEGORI</span><input class="form-inp" id="i-cat"></div>
                <div class="col-2"><span class="label">BABAK</span><input class="form-inp" id="i-round"></div>
                <div class="col-2"><span class="label">COURT</span><input class="form-inp" id="i-court"></div>
                <div class="col-2"><span class="label">WASIT</span><input class="form-inp" id="i-ref"></div>
                <div class="col-2"><span class="label">TIM A</span><input class="form-inp" id="i-ta" style="font-weight:bold"></div>
                <div class="col-2"><span class="label">TIM B</span><input class="form-inp" id="i-tb" style="font-weight:bold"></div>
                <div class="col-4"><span class="label">NOTE</span><input class="form-inp" id="i-note"></div>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button onclick="closeModal()" style="padding:10px; background:#eee; border:none;">Batal</button>
                <button onclick="saveMatch()" class="btn btn-add">SIMPAN</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETTING KEAMANAN ---
        const KODE_RAHASIA = "admin123"; // <--- GANTI PASSWORD DI SINI
        let isUnlocked = false; // Status Kunci (Default: Terkunci)

        function checkPass() {
            const val = document.getElementById('pass-input').value;
            if(val === KODE_RAHASIA) {
                // BUKA KUNCI
                isUnlocked = true; 
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.body.style.overflow = 'auto';
                
                // BARU PANGGIL DATABASE
                initSupabase(); 
            } else {
                // SALAH
                const err = document.getElementById('err-msg');
                err.style.display = 'block';
                err.classList.add('shake'); // Animasi getar (opsional)
            }
        }

        // --- 2. SUPABASE LOGIC (DIBUNGKUS FUNGSI) ---
        const SUPABASE_URL = 'https://gubcvxiupehbdpigrdct.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k1y6fNI2opEXhwqKMbGYcA__2nD0yT6';
        let db;

        // Fungsi ini HANYA jalan setelah password benar
        function initSupabase() {
            if(!isUnlocked) return; // Double check
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Load Data Awal
            loadData();

            // Hidupkan Realtime
            db.channel('public:matches').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, () => {
                if(isUnlocked) loadData(); // Hanya update kalau sudah unlock
            }).subscribe();
        }

        async function loadData() {
            if(!isUnlocked || !db) return; // Stop jika belum login
            const { data } = await db.from('matches').select('*').order('created_at', {ascending: true});
            if(data) render(data);
        }

        function render(data) {
            const tbody = document.getElementById('tabel-body');
            tbody.innerHTML = "";
            data.forEach(m => {
                const inp = (f, v, c='') => `<input value="${v||''}" onchange="upd('${m.id}','${f}',this.value)" class="${c}">`;
                const num = (f, v) => `<input type="number" value="${v}" onchange="upd('${m.id}','${f}',this.value)" class="inp-score">`;
                const txt = (f, v, c='') => `<textarea onchange="upd('${m.id}','${f}',this.value)" class="inp-wrap ${c}">${v||''}</textarea>`;

                let badgeClass = m.status === 'LIVE' ? 'st-live' : (m.status === 'FINISHED' ? 'st-done' : 'st-pending');
                let badgeIcon = m.status === 'LIVE' ? 'STOP' : (m.status === 'FINISHED' ? 'DONE' : 'LIVE');
                let woCheck = m.is_wo ? 'checked' : '';
                
                let row = `<tr>
                    <td>${inp('match_no', m.match_no)}</td>
                    <td>${inp('pin', m.pin, 'inp-pin')}</td>
                    <td style="background:#fafafa">${txt('date', m.date)}</td>
                    <td style="background:#fafafa">${inp('time', m.time)}</td>
                    <td style="background:#fafafa">${txt('court_name', m.court_name, 'inp-court')}</td>
                    <td style="background:#fafafa">${txt('category', m.category)}</td>
                    <td style="background:#fafafa">${txt('round', m.round)}</td>
                    <td style="background:#fafafa">${txt('referee_name', m.referee_name)}</td>
                    <td class="td-team-a">${txt('team_a', m.team_a)}</td>
                    <td class="bg-set">${num('set1_a', m.set1_a)}</td> <td class="bg-set">${num('set1_b', m.set1_b)}</td>
                    <td class="bg-set">${num('set2_a', m.set2_a)}</td> <td class="bg-set">${num('set2_b', m.set2_b)}</td>
                    <td class="bg-set">${num('set3_a', m.set3_a)}</td> <td class="bg-set">${num('set3_b', m.set3_b)}</td>
                    <td class="bg-set">${num('set4_a', m.set4_a)}</td> <td class="bg-set">${num('set4_b', m.set4_b)}</td>
                    <td class="bg-set">${num('set5_a', m.set5_a)}</td> <td class="bg-set">${num('set5_b', m.set5_b)}</td>
                    <td class="bg-poin">${inp('points_a', m.points_a, 'inp-score')}</td>
                    <td class="bg-poin">${inp('points_b', m.points_b, 'inp-score')}</td>
                    <td class="td-team-b">${txt('team_b', m.team_b)}</td>
                    <td><input type="checkbox" ${woCheck} onchange="upd('${m.id}','is_wo',this.checked)"></td>
                    <td style="white-space:nowrap;">
                        <span class="badge ${badgeClass}" onclick="toggleStatus('${m.id}', '${m.status}', '${m.court_name}')">${badgeIcon}</span>
                        <button class="btn-fin" onclick="setFinish('${m.id}')">‚úÖ</button>
                    </td>
                    <td><button onclick="del('${m.id}')" style="border:none; bg:none; cursor:pointer;">üóëÔ∏è</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- FUNGSI UPDATE ---
        async function upd(id, field, val) { 
            if(!isUnlocked) return; 
            showToast(); await db.from('matches').update({[field]: val}).eq('id', id); 
        }
        async function toggleStatus(id, st, crt) {
            if(!isUnlocked) return;
            let next = st === 'LIVE' ? 'PENDING' : 'LIVE';
            if(next === 'LIVE') {
                const {data} = await db.from('matches').select('*').ilike('court_name', crt).eq('status', 'LIVE');
                if(data.length > 0) return alert('Court sibuk!');
            }
            await db.from('matches').update({status: next}).eq('id', id);
        }
        async function setFinish(id) {
            if(!isUnlocked || !confirm("Selesai?")) return;
            await db.from('matches').update({status: 'FINISHED'}).eq('id', id);
        }
        async function saveMatch() {
            if(!isUnlocked) return;
            const payload = {
                match_no: document.getElementById('i-no').value,
                pin: document.getElementById('i-pin').value,
                time: document.getElementById('i-jam').value,
                date: document.getElementById('i-date').value,
                category: document.getElementById('i-cat').value,
                round: document.getElementById('i-round').value,
                court_name: document.getElementById('i-court').value,
                referee_name: document.getElementById('i-ref').value,
                team_a: document.getElementById('i-ta').value,
                team_b: document.getElementById('i-tb').value,
                notes: document.getElementById('i-note').value
            };
            await db.from('matches').insert([payload]);
            closeModal();
        }
        async function del(id) { if(isUnlocked && confirm('Hapus?')) await db.from('matches').delete().eq('id', id); }

        // UTILS
        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function showToast() { const t=document.getElementById('toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',800); }

    </script>
</body>
</html>